<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIXO ANIME HUB - Realtime DB</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* CSS Wahi purana wala hai (Design same rahega) */
        :root {
            --primary: #f47521;
            --bg-main: #000000;
            --bg-card: #23252b;
            --text-main: #ffffff;
            --border-color: #333;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Lato', sans-serif; background: var(--bg-main); color: var(--text-main); padding-top: 65px; }
        
        /* Navbar */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 65px; background: rgba(20,21,25,0.95); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; z-index: 1000; }
        .brand { font-size: 24px; font-weight: 900; color: white; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .brand span { color: var(--primary); }
        .nav-actions { display: flex; gap: 15px; }
        .search-input { background: #191a1e; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 4px; }
        
        /* Hero & Grid */
        .hero { height: 350px; background: linear-gradient(to bottom, transparent, #000), url('https://wallpapers.com/images/hd/demon-slayer-4k-desktop-q935j83533j533j5.jpg') center/cover; display: flex; align-items: flex-end; padding: 30px 5%; }
        .hero h1 { font-size: 40px; margin: 0; text-shadow: 2px 2px 4px #000; }
        
        .main-container { padding: 30px 5%; }
        .anime-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        
        /* Cards */
        .card { cursor: pointer; transition: 0.3s; position: relative; }
        .card:hover { transform: scale(1.05); }
        .poster { width: 100%; aspect-ratio: 2/3; background: #222; border-radius: 6px; overflow: hidden; position: relative; }
        .poster img { width: 100%; height: 100%; object-fit: cover; }
        .card-title { margin-top: 10px; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Player */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .video-box iframe { width: 100%; height: 100%; border: none; }
        .ep-list { max-height: 300px; overflow-y: auto; background: #222; padding: 10px; border-radius: 6px; }
        .ep-item { padding: 10px; background: #333; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .ep-item:hover, .ep-item.active { background: var(--primary); color: black; font-weight: bold; }

        /* Admin */
        .admin-panel { max-width: 600px; margin: 0 auto; background: #222; padding: 20px; border-radius: 8px; }
        .form-control { width: 100%; padding: 12px; margin-bottom: 10px; background: #111; border: 1px solid #444; color: white; }
        .btn { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; font-weight: bold; cursor: pointer; }
        .delete-btn { position: absolute; top: 5px; right: 5px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; z-index: 10; display: none; }

        /* Mobile */
        @media(max-width: 768px) { .anime-grid { grid-template-columns: repeat(2, 1fr); } .search-input { display: none; } }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="brand" onclick="router('home')"><i class="fas fa-play-circle"></i> FLIXO <span>HUB</span></div>
        <div class="nav-actions">
            <button onclick="router('admin')" style="background:none; border:1px solid var(--primary); color:var(--primary); padding:5px 10px; cursor:pointer;">ADMIN</button>
        </div>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="view-section active">
        <div class="hero">
            <div>
                <span style="background:var(--primary); color:black; padding:2px 5px; font-weight:bold; font-size:12px;">NEW</span>
                <h1>Watch Anime Online</h1>
            </div>
        </div>
        
        <div id="ad-banner" style="text-align:center; padding:10px; background:#111; display:none;"></div>

        <div class="main-container">
            <h3>Latest Series</h3>
            <div id="anime-grid" class="anime-grid">Loading...</div>
        </div>
    </section>

    <!-- VIEW: PLAYER -->
    <section id="view-player" class="view-section">
        <div class="main-container">
            <button onclick="router('home')" style="background:none; color:#aaa; margin-bottom:10px; cursor:pointer;">&larr; Back</button>
            <div class="video-box">
                <iframe id="videoPlayer" src="" allowfullscreen></iframe>
            </div>
            <h2 id="playerTitle">Anime Title</h2>
            <div id="epList" class="ep-list"></div>
        </div>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="view-section">
        <div class="main-container">
            <div class="admin-panel">
                <h2>Admin Dashboard</h2>
                
                <!-- TABS -->
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn" onclick="ui.showTab('addAnime')" style="flex:1">Add Anime</button>
                    <button class="btn" onclick="ui.showTab('addEp')" style="flex:1; background:#444;">Add Ep</button>
                    <button class="btn" onclick="ui.showTab('ads')" style="flex:1; background:#444;">Ads</button>
                </div>

                <!-- ADD ANIME -->
                <div id="tab-addAnime">
                    <input type="text" id="newTitle" class="form-control" placeholder="Anime Title">
                    <input type="text" id="newImg" class="form-control" placeholder="Poster Image URL">
                    <button class="btn" onclick="admin.saveAnime()">Save Anime (Push)</button>
                </div>

                <!-- ADD EPISODE -->
                <div id="tab-addEp" style="display:none;">
                    <select id="animeSelect" class="form-control"><option>Loading...</option></select>
                    <input type="text" id="epTitle" class="form-control" placeholder="Episode Name (e.g. Ep 1)">
                    <input type="text" id="epLink" class="form-control" placeholder="Embed Link">
                    <button class="btn" onclick="admin.saveEpisode()">Add Episode (Push)</button>
                </div>

                <!-- ADS -->
                <div id="tab-ads" style="display:none;">
                    <textarea id="adCode" class="form-control" rows="5" placeholder="Ad HTML Code"></textarea>
                    <button class="btn" onclick="admin.saveAds()">Update Ads (Set)</button>
                </div>
            </div>
        </div>
    </section>

    <!-- JAVASCRIPT (REALTIME DATABASE VERSION) -->
    <script type="module">
        // 1. IMPORT REALTIME DATABASE MODULES
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. CONFIGURATION (Apna Config Yahan Dalein)
        const firebaseConfig = {
            apiKey: "AIzaSyC-UnVb3R8mTMWVW3b-k7v0Ttll-mZBZ3I",
            authDomain: "flixo-6cb4c.firebaseapp.com",
            databaseURL: "https://flixo-6cb4c-default-rtdb.firebaseio.com", // <-- Database URL Zaroori hai RTDB ke liye
            projectId: "flixo-6cb4c",
            storageBucket: "flixo-6cb4c.firebasestorage.app",
            messagingSenderId: "568105225939",
            appId: "1:568105225939:web:dc2e3cec494e54200fce26"
        };

        // Initialize Realtime DB
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global State
        let animeData = {}; 
        let isAdmin = localStorage.getItem('flixo_admin') === 'true';

        // 3. LOAD DATA (USING onValue for Realtime Updates)
        function initApp() {
            const animeRef = ref(db, 'anime');
            const adsRef = ref(db, 'settings/ads');

            // Load Anime
            onValue(animeRef, (snapshot) => {
                const grid = document.getElementById('anime-grid');
                const select = document.getElementById('animeSelect');
                grid.innerHTML = '';
                select.innerHTML = '<option value="">Select Anime...</option>';
                animeData = {};

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    animeData = data; // Store globally

                    // Loop through object keys (RTDB returns object, not array)
                    Object.keys(data).forEach(key => {
                        const anime = data[key];
                        
                        // Create Card
                        const card = document.createElement('div');
                        card.className = 'card';
                        // Delete Button logic
                        const delBtn = isAdmin ? `<div class="delete-btn" style="display:flex" onclick="event.stopPropagation(); admin.deleteAnime('${key}')"><i class="fas fa-trash"></i></div>` : '';
                        
                        card.innerHTML = `
                            <div class="poster">
                                <img src="${anime.image}" onerror="this.src='https://via.placeholder.com/200'">
                                ${delBtn}
                            </div>
                            <div class="card-title">${anime.title}</div>
                        `;
                        card.onclick = () => loadPlayer(key, anime);
                        grid.appendChild(card);

                        // Admin Dropdown
                        let opt = document.createElement('option');
                        opt.value = key;
                        opt.innerText = anime.title;
                        select.appendChild(opt);
                    });
                } else {
                    grid.innerHTML = '<p>No anime added yet.</p>';
                }
            });

            // Load Ads
            onValue(adsRef, (snapshot) => {
                if(snapshot.exists()) {
                    const code = snapshot.val().code;
                    document.getElementById('ad-banner').innerHTML = code;
                    document.getElementById('ad-banner').style.display = 'block';
                    document.getElementById('adCode').value = code;
                }
            });
        }

        // 4. PLAYER LOGIC
        window.loadPlayer = (id, anime) => {
            router('player');
            document.getElementById('playerTitle').innerText = anime.title;
            const list = document.getElementById('epList');
            const video = document.getElementById('videoPlayer');
            list.innerHTML = '';
            video.src = '';

            // Check if episodes exist
            if(anime.episodes) {
                // Convert object to array (RTDB stores lists as objects with unique keys)
                const episodes = Object.keys(anime.episodes).map(k => anime.episodes[k]);
                
                if(episodes.length > 0) {
                    video.src = episodes[0].link; // Play first
                    
                    episodes.forEach((ep, idx) => {
                        const div = document.createElement('div');
                        div.className = 'ep-item';
                        div.innerHTML = `<span>${ep.title}</span> <i class="fas fa-play"></i>`;
                        div.onclick = () => {
                            video.src = ep.link;
                            document.querySelectorAll('.ep-item').forEach(e => e.classList.remove('active'));
                            div.classList.add('active');
                        };
                        list.appendChild(div);
                    });
                }
            } else {
                list.innerHTML = '<p style="color:#777">No episodes yet.</p>';
            }
        };

        // 5. ADMIN LOGIC
        window.admin = {
            saveAnime: () => {
                const title = document.getElementById('newTitle').value;
                const img = document.getElementById('newImg').value;
                if(!title || !img) return alert("Fill all fields");

                // PUSH use kar rahe hain unique ID ke liye
                push(ref(db, 'anime'), {
                    title: title,
                    image: img,
                    timestamp: Date.now()
                }).then(() => {
                    alert("Anime Saved!");
                    document.getElementById('newTitle').value = "";
                });
            },

            saveEpisode: () => {
                const animeId = document.getElementById('animeSelect').value;
                const title = document.getElementById('epTitle').value;
                const link = document.getElementById('epLink').value;
                
                if(!animeId || !link) return alert("Select Anime & Link");

                // Nested PUSH use kar rahe hain episodes list ke liye
                push(ref(db, 'anime/' + animeId + '/episodes'), {
                    title: title,
                    link: link
                }).then(() => {
                    alert("Episode Added!");
                    document.getElementById('epLink').value = "";
                });
            },

            saveAds: () => {
                const code = document.getElementById('adCode').value;
                // SET use kar rahe hain overwrite karne ke liye
                set(ref(db, 'settings/ads'), {
                    code: code
                }).then(() => alert("Ads Updated!"));
            },

            deleteAnime: (id) => {
                if(confirm("Delete this anime?")) {
                    remove(ref(db, 'anime/' + id)); // Remove Data
                }
            }
        };

        // 6. UTILITIES
        window.router = (view) => {
            // Admin Auth Check
            if(view === 'admin' && !isAdmin) {
                const p = prompt("Password:");
                if(p === "16/2/2012-Rasel@") {
                    isAdmin = true;
                    localStorage.setItem('flixo_admin', 'true');
                } else {
                    return alert("Wrong Password");
                }
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
        };

        window.ui = {
            showTab: (id) => {
                document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none');
                document.getElementById('tab-' + id).style.display = 'block';
            }
        };

        // Start
        initApp();

    </script>
</body>
</html>